caRpools
========

The [**CaRpools**](https://cran.r-project.org/web/packages/caRpools/vignettes/CaRpools.html) (**C**RISPR **A**nalyze**R** for **Pool**ed **S**creens) package allows users to analyze raw NGS read count data from pooled CRISPR Screens in an end-to-end fashion and serves as a basis for creating customized reports for more advanced users.

## Installation

We need to install some packages first.

```
sudo apt-get update
sudo apt-get install default-jre
sudo apt-get install default-jdk
sudo apt-get install libxml2-dev

sudo R CMD javareconf
```

Then, we will install R packages. To install R, please refer to:

* **Gitbucket** -> **cluster_usage** -> **InstallR.md**
* **Github** -> **CRISPR_Screening** -> **3.CRISPRAnalyzeR.md** -> "Once the quantification is done, we will use R to prepare the input files."

```
install.packages("rJava")

if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
      
BiocManager::install("DESeq2")
BiocManager::install("biomaRt")

install.packages("caRpools")
install.packages("rafalib")
install.packages("VennDiagram")
```

## CRISPR Screening Analysis

### load data

```{r}
## control samples
control1 <- load.file("PBS-Replicate1.txt", header= TRUE, sep="\t")
control2 <- load.file("PBS-Replicate2.txt", header= TRUE, sep="\t")
## trails samples
trail1 <- load.file("TRAIL-Replicate1.txt", header= TRUE, sep="\t")
trail2 <- load.file("TRAIL-Replicate2.txt", header= TRUE, sep="\t")
```

We will also prepare the library data in fasta format. Please refer to **Github** -> **CRISPR_Screening** -> **3.CRISPRAnalyzeR.md**.

```{r}
libFILE = load.file("./data/pilotscreen_Fitness.fasta",header = FALSE, type="fastalib")
```

We can aggregate sgRNA read-counts to gene read-counts using `aggregatetogenes`:

```{r}
control1.g <- aggregatetogenes(data.frame=control1, agg.function=sum, extractpattern=expression("^(.+?)(_.+)"), type="aggregate")
control2.g <- aggregatetogenes(data.frame=control2, agg.function=sum, extractpattern=expression("^(.+?)(_.+)"), type="aggregate")
trail1.g <- aggregatetogenes(data.frame=trail1, agg.function=sum, extractpattern=expression("^(.+?)(_.+)"), type="aggregate")
trail2.g <- aggregatetogenes(data.frame=trail2, agg.function=sum, extractpattern=expression("^(.+?)(_.+)"), type="aggregate")
```

### quality control

1. dataset Statistics

```{r}
control1.stats <- stats.data(dataset=control1, namecolumn=1, fullmatchcolumn=2, extractpattern=expression("^(.+?)_.+"), type="stats")
control2.stats <- stats.data(dataset=control2, namecolumn=1, fullmatchcolumn=2, extractpattern=expression("^(.+?)_.+"), type="stats")
trail1.stats <- stats.data(dataset=trail1, namecolumn=1, fullmatchcolumn=2, extractpattern=expression("^(.+?)_.+"), type="stats")
trail2.stats <- stats.data(dataset=trail2, namecolumn=1, fullmatchcolumn=2, extractpattern=expression("^(.+?)_.+"), type="stats")

combined.stats <- cbind.data.frame(control1.stats[,1:2], control2.stats[,2], trail1.stats[,2], trail2.stats[,2])
colnames(combined.stats) <- c("Readcount", "control1", "control2", "trail1", "trail1")
```

2. read-count distribution

```{r}
mypar(2,2)
carpools.read.distribution(control1, fullmatchcolumn=2, breaks=200, title="control1", xlab="log2 Readcount", ylab="# sgRNAs", statistics=TRUE)
carpools.read.distribution(control1, fullmatchcolumn=2, breaks=200, title="control1", xlab="log2 Readcount", ylab="# sgRNAs",statistics=TRUE, type="whisker")
carpools.read.distribution(control2, fullmatchcolumn=2, breaks=200, title="control2", xlab="log2 Readcount", ylab="# sgRNAs", statistics=TRUE)
carpools.read.distribution(control2, fullmatchcolumn=2, breaks=200, title="control2", xlab="log2 Readcount", ylab="# sgRNAs",statistics=TRUE, type="whisker")

mypar(2,2)
carpools.read.distribution(trail1, fullmatchcolumn=2, breaks=200, title="trail1", xlab="log2 Readcount", ylab="# sgRNAs", statistics=TRUE)
carpools.read.distribution(trail1, fullmatchcolumn=2, breaks=200, title="trail1", xlab="log2 Readcount", ylab="# sgRNAs",statistics=TRUE, type="whisker")
carpools.read.distribution(trail2, fullmatchcolumn=2, breaks=200, title="trail2", xlab="log2 Readcount", ylab="# sgRNAs", statistics=TRUE)
carpools.read.distribution(trail2, fullmatchcolumn=2, breaks=200, title="trail2", xlab="log2 Readcount", ylab="# sgRNAs",statistics=TRUE, type="whisker")

## Add specific gene
mypar(3,1)
carpools.read.distribution(trail1, fullmatchcolumn=2, breaks=200, title="trail1", xlab="log2 Readcount", ylab="# sgRNAs", statistics=TRUE)

# BAX
plot(1, type="n", xlab="", ylab="", xlim=c(0, log2(max(control1$Count))), ylim=c(0, 2), xaxt = 'n', yaxt = 'n')
abline(v=log2(ifelse(control1[grep("BAX", control1$sgRNA), "Count"]==0, 1, control1[grep("BAX", control1$sgRNA), "Count"])), col="#de2d26")

# CASP8
plot(1, type="n", xlab="", ylab="", xlim=c(0, log2(max(control1$Count))), ylim=c(0, 2), xaxt = 'n', yaxt = 'n')
abline(v=log2(ifelse(control1[grep("CASP8", control1$sgRNA), "Count"]==0, 1, control1[grep("CASP8", control1$sgRNA), "Count"])), col="#31a354")
```

3. read count control vs. treated

```{r}
## sgRNA plot
carpools.read.count.vs(dataset=list(control1, trail1), dataset.names = c("control1", "trail1"), pairs=FALSE, namecolumn=1, fullmatchcolumn=2, title="", pch=19, normalize=TRUE, norm.function=median, labelgenes="random", labelcolor="blue", center=FALSE, aggregated=FALSE)

carpools.read.count.vs(dataset=list(control1, trail1), dataset.names = c("control1", "trail1"), pairs=FALSE, namecolumn=1, fullmatchcolumn=2, title="", pch=19, normalize=TRUE, norm.function=median, labelgenes="CASP8", labelcolor="red", center=FALSE, aggregated=FALSE)

## highlight gene (use aggregated data e.g., control1.g)
carpools.read.count.vs(dataset=list(control1.g, trail1.g), dataset.names = c("control1", "trail1"), pairs=FALSE, namecolumn=1, fullmatchcolumn=2, title="", pch=19, normalize=TRUE, norm.function=median, labelgenes="CASP8", labelcolor="red", center=FALSE, aggregated=FALSE)
```

4. sgRNA phenotype for specific gene

```{r}
## fold change
p1 <- carpools.raw.genes(untreated.list = list(control1, control2), treated.list = list(trail1, trail2), genes="CASP8", namecolumn=1, fullmatchcolumn=2, norm.function=median, extractpattern=expression("^(.+?)_.+"), do.plot=TRUE, log=FALSE, put.names=TRUE, type="foldchange")

## Z-score
p2 <- carpools.raw.genes(untreated.list = list(control1, control2), treated.list = list(trail1, trail2), genes="CASP8", namecolumn=1, fullmatchcolumn=2, norm.function=median, extractpattern=expression("^(.+?)_.+"), do.plot=TRUE, log=FALSE, put.names=TRUE, type="z-ratio")

## read count
p3 <- carpools.raw.genes(untreated.list = list(control1, control2), treated.list = list(trail1, trail2), genes="CASP8", namecolumn=1, fullmatchcolumn=2, norm.function=median, extractpattern=expression("^(.+?)_.+"), do.plot=TRUE, log=FALSE, put.names=TRUE, type="readcount" )
```

### Hit Calling / Candidate Analysis

It is important to mention that no individual analysis method will perform well in all datasets and CRISPR pooled screens, thus it is important to check the result of each method as it is provided by caRpools.

Hit analysis is performed using three different methods:

* **Wilcox**: a sgRNA population vs. sgRNA population comparison using a Wilcoxon Test
* **DESeq2**: gene-level to perform analysis on gene-level read-count instead of individual sgRNA read-counts
* **MAGeCK**: a rank-based model to test for a change in abundance of sgRNAs after median normalization of the data-set

1. Wilcox

```{r}
# if non-target controls, assign gene identifier (character) to controls 
# control.picks is only used if controls=NULL
source("stat.wilcox2.R")
data.wilcox <- stat.wilcox2(untreated.list=list(control1, control2), treated.list=list(trail1, trail2), namecolumn=1, fullmatchcolumn=2, normalize=TRUE, norm.fun=median, sorting=FALSE, controls="random", control.picks=NULL)

```

2. DEseq

```{r}
data.deseq <-  stat.DESeq(untreated.list=list(control1, control2), treated.list=list(trail1, trail2), namecolumn=1, fullmatchcolumn=2, extractpattern=expression("^(.+?)(_.+)"), sorting=FALSE, filename.deseq="ANALYSIS-DESeq2-sgRNA.tab", fitType="parametric")

data.deseq$sgRNA # sgRNA calculations
data.deseq$genes # gene calculations
```

3. MAGeCK

```
sudo apt-get install python-numpy python-scipy python-matplotlib
sudo apt-get install haskell-platform
tar -zxvf mageck-0.5.9.3.tar.gz
cd mageck-0.5.9.3/
python setup.py install
```

```{r}
source("stat.mageck2.R")
data.mageck <- stat.mageck2(untreated.list=list(control1, control2), treated.list=list(trail1, trail2), namecolumn=1, fullmatchcolumn=2, norm.fun="median", extractpattern=expression("^(.+?)(_.+)"), mageckfolder=NULL, sort.criteria="neg", adjust.method="fdr", filename = "TEST" , fdr.pval = 0.05)

data.mageck$sgRNA # sgRNA calculations
data.mageck$genes # gene calculations

carpools.waterfall.pval(type="mageck", dataset=data.mageck, pval=0.05, log=TRUE)
```

The output from `stat.wilcox`, `stat.DEseq` and `stat.mageck2` can be visualized with `carpools.hitident`.
In this case, **log2 fold changes** are plotted against the **gene names** for all methods as well as the number of significant sgRNAs for data analyzed with `DESeq2` or `MAGeCK`.

```{r}
carpools.hit.overview(wilcox=data.wilcox, deseq=data.deseq, mageck=data.mageck, cutoff.deseq = 0.001, cutoff.wilcox = 0.05, cutoff.mageck = 0.05, cutoff.override=FALSE, cutoff.hits=NULL, plot.genes="overlapping", type="enriched")


## Venn Diagram
library(VennDiagram)
venn.enriched <- compare.analysis(wilcox=data.wilcox, deseq=data.deseq, mageck=data.mageck, type="enriched", cutoff.deseq = 0.001, cutoff.wilcox = 0.05, cutoff.mageck = 0.05, cutoff.override=FALSE, cutoff.hits=NULL, output="venn")

plot.new()
grid::grid.draw(VennDiagram::venn.diagram(venn.enriched, file=NULL, fill=c("lightgreen","lightblue2","lightgray"), na="remove", cex=2,lty=2, cat.cex=2))

## List
data.analysis.list <- compare.analysis(wilcox=data.wilcox, deseq=data.deseq, mageck=data.mageck, type="enriched", cutoff.override = FALSE, cutoff.hits=NULL, output="list", sort.by=c("mageck","fdr","rank"))

## Rank-based Output
data.analysis.rank <- compare.analysis(wilcox=data.wilcox, deseq=data.deseq, mageck=data.mageck, type="enriched", cutoff.override = FALSE, cutoff.hits=NULL, output="rank", sort.by=c("mageck","fdr","rank"))

## Creating Final Hit Candidate Table
final.tab <- final.table(wilcox=data.wilcox, deseq=data.deseq, mageck=data.mageck, dataset=control1.g, namecolumn=1, type="genes")

## Create List of Overlapping Hit Candidates
overlap.enriched <- generate.hits(wilcox=data.wilcox, deseq=data.deseq, mageck=data.mageck, type="enriched", cutoff.deseq = 0.001, cutoff.wilcox = 0.05, cutoff.mageck = 0.05, cutoff.override=FALSE, cutoff.hits=NULL , plot.genes="overlapping")

## Read-Count Scatter Plots for Candidate Genes

plothitsscatter.enriched <-carpools.hit.scatter(wilcox=data.wilcox, deseq=data.deseq, mageck=data.mageck, dataset=list(control1, control2, trail1, trail2), dataset.names = c("control1", "control2", "trail1", "trail2"), namecolumn=1, fullmatchcolumn=2, title="Title", labelgenes="CASP8", labelcolor="orange", extractpattern=expression("^(.+?)(_.+)"), normalize=TRUE, norm.function=median, offsetplot=1.2, center=FALSE, aggregated=FALSE, type="enriched", cutoff.deseq = 0.001, cutoff.wilcox = 0.05, cutoff.mageck = 0.05, cutoff.override=FALSE, cutoff.hits=NULL, pch=16)

## sgRNA Effect Plots

sgrnas.en <- carpools.hit.sgrna(wilcox=data.wilcox, deseq=data.deseq, mageck=data.mageck, dataset=list(control1, control2, trail1, trail2), dataset.names = c("control1", "control2", "trail1", "trail2"), namecolumn=1, fullmatchcolumn=2, norm.function=median, extractpattern=expression("^(.+?)(_.+)"), put.names=TRUE, type="enriched", labelgenes="CASP8", plot.type=NULL, cutoff.deseq = 0.001, cutoff.wilcox=0.05, cutoff.mageck = 0.05, cutoff.override=FALSE, cutoff.hits=NULL, controls.target="CASP8", controls.nontarget="random")

## sgRNA Effect Table

sgrnas.en.table <- carpools.sgrna.table(wilcox=data.wilcox, deseq=data.deseq, mageck=data.mageck, dataset=list(control1, control2, trail1, trail2), dataset.names = c("control1", "control2", "trail1", "trail2"), namecolumn=1, fullmatchcolumn=2, norm.function=median, extractpattern=expression("^(.+?)(_.+)"), type="enriched", labelgenes="CASP8", cutoff.deseq = 0.001, cutoff.wilcox=0.05, cutoff.mageck = 0.05, cutoff.override=FALSE, cutoff.hits=NULL, sgrna.file = libFILE, write=FALSE)
```